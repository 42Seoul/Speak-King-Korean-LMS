# 특정 학생 맞춤형 콘텐츠 - 간단 구현 계획

## 개요
기존 `study_sets` 테이블에 `targeted_students` 컬럼만 추가하여 특정 학생만 볼 수 있는 학습 세트를 생성하는 기능 구현

## 1. 데이터베이스 변경

### 1.1 테이블 수정
```sql
-- study_sets 테이블에 컬럼 추가
alter table public.study_sets
  add column targeted_students uuid[] default null;

-- 인덱스 추가 (성능 최적화)
create index idx_study_sets_targeted on study_sets using gin(targeted_students);
```

### 1.2 RLS 정책 수정

```sql
-- 기존 학생 조회 정책 삭제
drop policy if exists "Students can view public study sets" on study_sets;

-- 새로운 학생 조회 정책
create policy "Students can view accessible study sets" on study_sets
  for select
  using (
    -- Case 1: Public 콘텐츠 (is_public = true)
    is_public = true
    or
    -- Case 2: 본인이 생성한 콘텐츠
    owner_id = auth.uid()
    or
    -- Case 3: 본인이 타겟팅된 콘텐츠 (is_public = false and 내 ID가 배열에 포함)
    (
      is_public = false
      and targeted_students is not null
      and auth.uid() = any(targeted_students)
    )
  );
```

**설명**:
- `is_public = true`: 기존처럼 모든 학생이 볼 수 있음
- `is_public = false` + `targeted_students = null`: 교사만 볼 수 있음 (Private)
- `is_public = false` + `targeted_students = [학생IDs]`: 지정된 학생만 볼 수 있음 (Targeted)

## 2. UI 변경

### 2.1 콘텐츠 생성 페이지 수정
**파일**: `app/(teacher)/management/content/new/page.tsx`

#### 추가할 State
```typescript
const [isPublic, setIsPublic] = useState(true)
const [targetedStudents, setTargetedStudents] = useState<string[]>([])
const [students, setStudents] = useState<any[]>([])
```

#### 추가할 UI (Metadata Card 안에)
```tsx
{/* 공개 범위 설정 */}
<div className="grid gap-2">
  <Label>공개 범위</Label>
  <Select
    value={isPublic ? "public" : (targetedStudents.length > 0 ? "targeted" : "private")}
    onValueChange={(val) => {
      if (val === "public") {
        setIsPublic(true)
        setTargetedStudents([])
      } else if (val === "private") {
        setIsPublic(false)
        setTargetedStudents([])
      } else if (val === "targeted") {
        setIsPublic(false)
        // targeted_students 배열은 아래에서 설정
      }
    }}
  >
    <SelectTrigger>
      <SelectValue />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="public">전체 공개 - 모든 학생</SelectItem>
      <SelectItem value="private">비공개 - 나만 보기</SelectItem>
      <SelectItem value="targeted">특정 학생만</SelectItem>
    </SelectContent>
  </Select>
</div>

{/* 학생 선택 (targeted일 때만 표시) */}
{!isPublic && (
  <div className="grid gap-2">
    <Label>학습할 학생 선택 ({targetedStudents.length}명)</Label>
    <ScrollArea className="h-[150px] border rounded p-3">
      {students.map(student => (
        <div key={student.id} className="flex items-center space-x-2 py-1">
          <Checkbox
            id={`student-${student.id}`}
            checked={targetedStudents.includes(student.id)}
            onCheckedChange={() => {
              setTargetedStudents(prev =>
                prev.includes(student.id)
                  ? prev.filter(id => id !== student.id)
                  : [...prev, student.id]
              )
            }}
          />
          <Label htmlFor={`student-${student.id}`} className="font-normal text-sm">
            {student.nickname || student.email}
          </Label>
        </div>
      ))}
    </ScrollArea>
  </div>
)}
```

#### 학생 목록 fetch (useEffect 추가)
```typescript
useEffect(() => {
  async function fetchStudents() {
    const { data } = await supabase
      .from('profiles')
      .select('id, email, nickname')
      .eq('role', 'student')
      .order('nickname')

    setStudents(data || [])
  }
  fetchStudents()
}, [])
```

#### handleSubmit 수정
```typescript
const handleSubmit = async () => {
  // ... 기존 검증 로직 ...

  const { error } = await supabase
    .from('study_sets')
    .insert({
      owner_id: user.id,
      title,
      description,
      type: 'sentence',
      target_repeat: targetRepeat,
      is_public: isPublic,
      targeted_students: !isPublic && targetedStudents.length > 0
        ? targetedStudents
        : null,  // ← 추가
      content: finalItems
    } as any)

  // ... 나머지 로직 ...
}
```

### 2.2 콘텐츠 수정 페이지도 동일하게 적용
**파일**: `app/(teacher)/management/content/[id]/edit/edit-form.tsx`

동일한 UI와 로직을 추가하되, 초기값을 기존 study set의 데이터로 설정

## 3. 구현 단계

### Step 1: 데이터베이스 마이그레이션
1. Supabase 대시보드 → SQL Editor
2. 위의 SQL 스크립트 실행
3. RLS 정책 확인

### Step 2: 타입 정의 업데이트
```bash
npx supabase gen types typescript --project-id "your-id" > types/database.types.ts
```

### Step 3: UI 구현
1. `content/new/page.tsx` 수정
2. `content/[id]/edit/edit-form.tsx` 수정
3. shadcn/ui 컴포넌트 추가 (필요시)
   - `npx shadcn-ui@latest add scroll-area`
   - `npx shadcn-ui@latest add checkbox`

### Step 4: 테스트
1. 교사 계정으로 Targeted 콘텐츠 생성
2. 타겟 학생으로 로그인 → 콘텐츠 보이는지 확인
3. 비타겟 학생으로 로그인 → 콘텐츠 안 보이는지 확인

## 4. 간단한 로직 흐름

```
교사가 콘텐츠 생성
  ↓
공개 범위 선택
  ├─ 전체 공개: is_public = true, targeted_students = null
  ├─ 비공개: is_public = false, targeted_students = null
  └─ 특정 학생: is_public = false, targeted_students = [학생ID들]
  ↓
DB 저장
  ↓
RLS 정책이 자동으로 필터링
  ↓
학생 대시보드에서 본인이 볼 수 있는 콘텐츠만 표시
```

## 5. 추가 개선 사항 (Optional)

### 5.1 콘텐츠 목록에 타겟 정보 표시
**파일**: `app/(teacher)/management/content/page.tsx`

```tsx
{studySet.targeted_students && studySet.targeted_students.length > 0 && (
  <Badge variant="secondary" className="text-xs">
    특정 학생 {studySet.targeted_students.length}명
  </Badge>
)}
```

### 5.2 학생 대시보드에 배지 표시
**파일**: `app/(student)/dashboard/page.tsx`

```tsx
{studySet.targeted_students && studySet.targeted_students.includes(userId) && (
  <Badge variant="outline" className="text-xs">
    맞춤형
  </Badge>
)}
```

## 6. SQL 마이그레이션 스크립트 (전체)

```sql
-- 1. 컬럼 추가
alter table public.study_sets
  add column if not exists targeted_students uuid[] default null;

-- 2. 인덱스 추가
create index if not exists idx_study_sets_targeted
  on study_sets using gin(targeted_students);

-- 3. RLS 정책 업데이트
drop policy if exists "Students can view public study sets" on study_sets;

create policy "Students can view accessible study sets" on study_sets
  for select
  using (
    is_public = true
    or owner_id = auth.uid()
    or (
      is_public = false
      and targeted_students is not null
      and auth.uid() = any(targeted_students)
    )
  );

-- 4. 교사/관리자 정책은 그대로 유지
-- (이미 모든 콘텐츠를 볼 수 있으므로 변경 불필요)
```

---

**예상 작업 시간**: 2-3시간
**위험도**: 낮음 (기존 테이블 수정만, 새 테이블 없음)
