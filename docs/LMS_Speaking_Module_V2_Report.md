# 📘 LMS 말하기 학습 모듈 (Speaking Practice System) V2.0 개발 리포트

## 1. 개요 (Overview)
본 문서는 Next.js 환경에서 구축된 '실시간 말하기 학습 시스템'의 아키텍처, 핵심 로직, 그리고 주요 기술적 이슈 해결 과정을 기술합니다.
이 모듈은 사용자가 원어민 오디오를 듣고 따라 말하면, AI(Web Speech API)가 실시간으로 인식하여 발음 정확도를 채점하는 기능을 제공합니다.

---

## 2. 핵심 아키텍처 및 구현 로직 (Core Logic)

### 2.1 음성 인식 엔진 (`hooks/use-speech.ts`)
브라우저 내장 `Web Speech API`를 React Custom Hook으로 래핑하여 사용합니다.

*   **Continuous Mode (`continuous: true`):**
    *   사용자가 문장 중간에 침묵하거나 쉬더라도 인식이 끊기지 않도록 설정했습니다.
    *   이는 유창성이 부족한 초급 학습자가 "저는... 조현석... 입니다"와 같이 띄엄띄엄 말하더라도 하나의 문장으로 인식하기 위함입니다.

*   **누적 전략 (Accumulation Strategy):**
    *   브라우저의 음성 인식 세션은 네트워크 불안정이나 타임아웃으로 인해 자동으로 재시작될 수 있습니다. 이때 기존 인식 기록이 날아가는 문제를 방지하기 위해, **Hook 내부에서 `accumulatedText` 변수에 확정된 문장(Final Results)을 별도로 누적 저장**합니다.
    *   화면 표시 텍스트 = `accumulatedText` (누적된 과거 문장) + `interimTranscript` (현재 말하고 있는 문장)

*   **낙관적 UI (Optimistic UI):**
    *   `startListening()` 호출 시 브라우저의 실제 `onstart` 이벤트를 기다리지 않고 즉시 상태를 `listening`으로 변경하여, "Waiting..."이라는 딜레이 메시지 없이 즉각적인 반응성을 제공합니다.
    *   **v2.1 변경사항:** 초기 마이크 권한 확인 단계에서는 사용자가 실제로 권한을 허용했는지 확인하기 위해 낙관적 UI를 비활성화(`optimistic=false`)하여, `onstart` 이벤트 수신 후 화면을 전환합니다.

### 2.2 평가 엔진 (`lib/utils.ts`)
사용자의 발화(`input`)와 정답(`target`)을 비교하여 점수를 산출합니다.

1.  **정규화 (Normalization):**
    *   특수문자(`.,?!`)와 공백을 모두 제거하고 소문자로 변환하여 비교합니다. (한국어/영어 공통)
2.  **포함 로직 (Contains Check):**
    *   사용자가 추임새("음...", "그게...")를 섞어 말하더라도, 핵심 정답 문장이 포함되어 있다면 **100점(통과)** 처리합니다.
3.  **유사도 검사 (Similarity Check):**
    *   Levenshtein Distance(편집 거리) 알고리즘을 사용하여 텍스트 유사도가 **70% 이상**이면 통과 처리합니다.

### 2.3 학습 플레이어 (`components/classroom/study-player.tsx`)
*   **세션 흐름 제어:**
    *   마이크 권한 확인 (통합된 화면) -> 오디오 재생 -> 듣기(녹음) -> 채점 -> (성공 시 0.5초 후) 다음 문제 자동 이동.
*   **자동 리셋:**
    *   다음 문제로 넘어갈 때 `stopListening` -> `resetTranscript` 순서로 호출하여 듣기 상태를 확실히 종료한 후 데이터를 비웁니다.
    *   `resetTranscript` 내부에서 `recognition.abort()`를 호출하여 물리적 세션을 강제로 종료, 이전 대화 기록이 새 문제에 섞이는 Race Condition을 방지합니다.

---

## 3. 주요 트러블 슈팅 (Troubleshooting History)

### 이슈 1: 띄엄띄엄 말할 때 문장이 사라짐
*   **현상:** "저는"이라고 말하고 쉬었다가 "조현석"이라고 말하면, "저는"이 사라지고 "조현석"만 남음.
*   **원인:** `continuous = false` (기본값) 설정으로 인해 침묵 시 세션이 종료되고, 재시작 시 이전 기록을 덮어씀.
*   **해결:** `continuous = true`로 변경하고, 세션이 끊겨도 텍스트를 보존하는 **자체 누적(Accumulation) 로직** 도입.

### 이슈 2: 다음 문제로 넘어가도 이전 텍스트가 남음
*   **현상:** 1번 문제를 맞히고 2번으로 갔는데, 화면에 1번 정답("안녕하세요")이 그대로 남아있음.
*   **원인:** 단순히 화면 변수만 지웠을 뿐, 브라우저 메모리(`recognition.results`)에는 이전 기록이 남아있어 다시 불러와짐.
*   **해결:** `resetTranscript` 함수에서 `recognition.abort()`를 호출하여 **브라우저의 음성 인식 세션을 물리적으로 강제 종료**시킴으로써 내부 버퍼를 초기화함.

### 이슈 3: 화면에 "Waiting..."이 너무 오래 뜸
*   **현상:** 말을 하려고 하는데 "Waiting..."이 뜨고 나서 한참 뒤에 글자가 나옴.
*   **원인:** `stop()` 후 `start()` 되는 과정에서 브라우저의 마이크 준비 시간(Latency)이 발생함.
*   **해결:** `startListening` 함수가 호출되자마자 UI 상태를 먼저 `listening`으로 바꾸는 **낙관적 업데이트** 적용.

### 이슈 4: 화면 표시와 평가 불일치
*   **현상:** 화면에는 글자가 보이는데 채점이 안 되거나, 그 반대 현상.
*   **원인:** `transcript`(평가용)와 `interimTranscript`(화면용) 상태가 분리되어 관리됨.
*   **해결:** 두 상태를 하나로 통합(`transcript`)하여, **화면에 보이는 텍스트가 곧 평가되는 텍스트**가 되도록 일원화함.

### 이슈 5: 문장 겹침 및 권한 요청 타이밍 (v2.1)
*   **현상:**
    1. 마이크 권한을 허용하기도 전에 첫 문제가 시작됨.
    2. 빠르게 문제를 넘길 때 이전 문장의 인식 결과가 다음 문제에 섞여서 오답 또는 오인식 발생.
*   **해결:**
    1. 초기 권한 확인 시에는 낙관적 UI를 끄고(`optimistic=false`), 실제 `onstart` 이벤트를 기다리도록 변경.
    2. `resetTranscript` 호출 시 즉시 `isListening` 플래그를 `false`로 꺼서, 뒤늦게 들어오는 인식 결과(`onresult`)나 종료 이벤트(`onend`)가 데이터를 오염시키지 않도록 방어 로직 추가.

---

## 4. 결론 및 향후 과제
현재 V2.1 모듈은 초기 목표했던 **"끊김 없는 연속 말하기"**와 **"정확한 실시간 평가"**, 그리고 **"안정적인 권한 처리 및 세션 전환"**을 모두 달성했습니다.
향후 과제로는 모바일 브라우저별(iOS Safari 등) 특이성 테스트와, 네트워크가 불안정한 환경에서의 재연결 안정성을 더욱 강화할 필요가 있습니다.

---

## 5. QA 및 테스트 체크리스트 (v2.1 업데이트)
다음은 최근 변경 사항(마이크 권한, Race Condition 방지)의 정상 동작을 검증하기 위한 테스트 목록입니다.

### 5.1 초기 설정 및 권한 (Permissions & Setup)
- [ ] **초기 화면 대기:** 학습 페이지 진입 시 마이크 권한을 묻지 않고 "Start Learning" 버튼이 있는 초기 화면에서 대기하는가?
- [ ] **권한 요청 대기:** 버튼 클릭 시 화면이 즉시 넘어가지 않고 "Checking..." 상태로 유지되며, 브라우저 권한 팝업이 뜨는가?
- [ ] **권한 허용 후 진입:** 권한 팝업에서 '허용'을 누른 후에야 비로소 첫 번째 문제(Round 1)로 화면이 전환되는가?
- [ ] **권한 거부 처리:** 권한을 거부하거나 브라우저에서 차단된 경우, 적절한 에러 메시지(Lock 아이콘 등)와 새로고침 버튼이 표시되는가?

### 5.2 학습 진행 및 안정성 (Flow & Stability)
- [ ] **잔상 제거:** 문장을 말하고 정답 처리된 후 다음 문제로 넘어갈 때, 이전 문장의 텍스트가 화면에 잠깐이라도 남지 않고 깨끗하게 초기화되는가?
- [ ] **빠른 스킵 안정성:** "Skip" 버튼이나 정답 처리를 통해 빠르게 연속으로 문제를 넘겨도, 이전 문장의 인식 결과가 다음 문제의 정답으로 잘못 인식되지 않는가? (Race Condition)
- [ ] **오디오 재생 중 인식:** 오디오가 재생되는 동안에는 마이크 아이콘이 비활성화(회색)되고, "Listening to audio..." 메시지가 표시되며 음성 인식이 중단되는가?
- [ ] **오디오 종료 후 자동 활성화:** 오디오 재생이 끝나면 자동으로 마이크가 켜지고(빨간색), "Listening..." 상태로 전환되는가?

### 5.3 인식 및 평가 (Recognition & Evaluation)
- [ ] **정답 인식:** 정확하게 문장을 말했을 때 즉시(또는 짧은 딜레이 후) 초록색 체크 표시와 함께 'Perfect!' 피드백이 뜨는가?
- [ ] **유사 정답:** 약간의 발음 실수나 추임새가 섞여도(유사도 70% 이상) 정답으로 처리되는가?
- [ ] **오답 무시:** 엉뚱한 말을 했을 때 정답으로 처리되지 않고, 계속해서 입력을 기다리는가?