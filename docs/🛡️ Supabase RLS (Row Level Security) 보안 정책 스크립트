ğŸ›¡ï¸ Supabase RLS (Row Level Security) ë³´ì•ˆ ì •ì±… ìŠ¤í¬ë¦½íŠ¸
ì´ ì½”ë“œë¥¼ Supabase SQL Editorì— ë³µì‚¬í•´ì„œ ì‹¤í–‰í•˜ì„¸ìš”. ì´ í•œ ë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ì„œë¹„ìŠ¤ì˜ ë³´ì•ˆ ì²´ê³„ê°€ ì™„ì„±ë©ë‹ˆë‹¤.

SQL

-- [1ë‹¨ê³„] ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™” (ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ì ‘ê·¼ ì°¨ë‹¨)
alter table public.profiles enable row level security;
alter table public.courses enable row level security;
alter table public.enrollments enable row level security;
alter table public.live_classes enable row level security;
alter table public.study_sets enable row level security;
alter table public.user_study_progress enable row level security;
alter table public.assignments enable row level security;
alter table public.weekly_rankings enable row level security;

-- [2ë‹¨ê³„] ì‚¬ìš©ì ì •ì˜ í•¨ìˆ˜ (Helper Functions)
-- êµì‚¬(teacher) ë˜ëŠ” ê´€ë¦¬ì(admin)ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ (ì •ì±… ì¬ì‚¬ìš©ì„±ì„ ìœ„í•´)
create or replace function public.is_teacher_or_admin()
returns boolean as $$
begin
  return exists (
    select 1 from public.profiles
    where id = auth.uid() and role in ('teacher', 'admin')
  );
end;
$$ language plpgsql security definer;


-- [3ë‹¨ê³„] í…Œì´ë¸”ë³„ ì„¸ë¶€ ì •ì±… (Policies)

-- 1. PROFILES (í”„ë¡œí•„)
-- ì¡°íšŒ: ëˆ„êµ¬ë‚˜ ìê¸° ìì‹ ì€ ë³¼ ìˆ˜ ìˆìŒ. êµì‚¬ëŠ” ëª¨ë“  í•™ìƒì„ ë³¼ ìˆ˜ ìˆìŒ.
create policy "Profiles are viewable by self or teachers" on public.profiles
  for select using ( auth.uid() = id or public.is_teacher_or_admin() );

-- ìˆ˜ì •: ìê¸° ìì‹ ë§Œ í”„ë¡œí•„(ë‹‰ë„¤ì„, ì•„ë°”íƒ€ ë“±) ìˆ˜ì • ê°€ëŠ¥
create policy "Users can update own profile" on public.profiles
  for update using ( auth.uid() = id );
  
-- ì‚½ì…: íšŒì›ê°€ì… íŠ¸ë¦¬ê±°ë¡œ ìë™ ìƒì„±ë˜ë¯€ë¡œ ì •ì±… ë¶ˆí•„ìš” (í˜¹ì€ ì„œë¹„ìŠ¤ ë¡¤ë§Œ ê°€ëŠ¥)


-- 2. COURSES (ê°•ì˜)
-- ì¡°íšŒ: ë¡œê·¸ì¸í•œ ëª¨ë“  ì‚¬ìš©ìê°€ ê°•ì˜ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆìŒ (ìˆ˜ê°• ì‹ ì²­ì„ ìœ„í•´)
create policy "Courses are viewable by everyone" on public.courses
  for select using ( auth.role() = 'authenticated' );

-- ìƒì„±/ìˆ˜ì •/ì‚­ì œ: êµì‚¬/ê´€ë¦¬ìë§Œ ê°€ëŠ¥
create policy "Only teachers can manage courses" on public.courses
  for all using ( public.is_teacher_or_admin() );


-- 3. ENROLLMENTS (ìˆ˜ê°• ì´ë ¥)
-- ì¡°íšŒ: í•™ìƒì€ ìê¸° ìˆ˜ê°• ì´ë ¥ë§Œ, êµì‚¬ëŠ” ì „ì²´ ìˆ˜ê°• ì´ë ¥ ì¡°íšŒ ê°€ëŠ¥
create policy "Enrollments viewable by owner or teacher" on public.enrollments
  for select using ( auth.uid() = user_id or public.is_teacher_or_admin() );

-- ìƒì„±(ìˆ˜ê°•ì‹ ì²­): ì‹œìŠ¤í…œ(ê²°ì œ í›„)ì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜, MVPì—ì„œëŠ” ë³¸ì¸ì´ ìƒì„± ê°€ëŠ¥í•˜ë‹¤ê³  ê°€ì •
-- (ë³´ì•ˆ ê°•í™” ì‹œ: Webhook ë“± ì„œë²„ ì‚¬ì´ë“œì—ì„œë§Œ insert ê¶Œì¥í•˜ì§€ë§Œ, MVPëŠ” Authenticated í—ˆìš©)
create policy "Users can enroll themselves" on public.enrollments
  for insert with check ( auth.uid() = user_id );


-- 4. LIVE_CLASSES (ë¼ì´ë¸Œ ìˆ˜ì—…)
-- ì¡°íšŒ: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ìˆ˜ì—… ëª©ë¡ ì¡°íšŒ ê°€ëŠ¥
create policy "Live classes viewable by authenticated" on public.live_classes
  for select using ( auth.role() = 'authenticated' );

-- ê´€ë¦¬: êµì‚¬ë§Œ ê°€ëŠ¥
create policy "Only teachers manage live classes" on public.live_classes
  for all using ( public.is_teacher_or_admin() );


-- 5. STUDY_SETS (í•™ìŠµ ì„¸íŠ¸) - [í•µì‹¬]
-- ì¡°íšŒ: 'Public'ì¸ ì„¸íŠ¸ ë˜ëŠ” 'ë‚´ê°€ ë§Œë“ ' ì„¸íŠ¸ë§Œ ì¡°íšŒ ê°€ëŠ¥. (êµì‚¬ëŠ” ë‹¤ ë³¼ ìˆ˜ ìˆê²Œ í•  ìˆ˜ë„ ìˆì§€ë§Œ ìš°ì„  ì›ì¹™ëŒ€ë¡œ)
create policy "Study sets viewable if public or owner" on public.study_sets
  for select using ( is_public = true or owner_id = auth.uid() );

-- ìƒì„±/ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ì´ ë§Œë“  ê²ƒë§Œ ê°€ëŠ¥
create policy "Users manage own study sets" on public.study_sets
  for all using ( owner_id = auth.uid() );


-- 6. USER_STUDY_PROGRESS (í•™ìŠµ ì§„ë„)
-- ì¡°íšŒ: í•™ìƒì€ ìê¸° ê²ƒë§Œ, êµì‚¬ëŠ” ëª¨ë“  í•™ìƒì˜ ì§„ë„ ì¡°íšŒ ê°€ëŠ¥ (ëª¨ë‹ˆí„°ë§)
create policy "Progress viewable by owner or teacher" on public.user_study_progress
  for select using ( auth.uid() = user_id or public.is_teacher_or_admin() );

-- ìˆ˜ì •(í•™ìŠµì§„í–‰): í•™ìƒì€ ìê¸° ì§„ë„ë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
create policy "Users update own progress" on public.user_study_progress
  for all using ( auth.uid() = user_id );


-- 7. ASSIGNMENTS (ìˆ™ì œ)
-- ì¡°íšŒ: í•™ìƒì€ ìê¸°ì—ê²Œ í• ë‹¹ëœ ê²ƒë§Œ, êµì‚¬ëŠ” ìê¸°ê°€ ë‚¸ ìˆ™ì œ(ë˜ëŠ” ì „ì²´) ì¡°íšŒ
create policy "Assignments viewable by student or teacher" on public.assignments
  for select using ( auth.uid() = student_id or public.is_teacher_or_admin() );

-- ê´€ë¦¬: êµì‚¬ë§Œ ìˆ™ì œ ìƒì„±/ìˆ˜ì • ê°€ëŠ¥
create policy "Only teachers manage assignments" on public.assignments
  for all using ( public.is_teacher_or_admin() );


-- 8. WEEKLY_RANKINGS (ë­í‚¹)
-- ì¡°íšŒ: ëˆ„êµ¬ë‚˜ ë­í‚¹ í™•ì¸ ê°€ëŠ¥
create policy "Rankings viewable by everyone" on public.weekly_rankings
  for select using ( true );
ğŸ“‚ [í•„ìˆ˜] Storage ë³´ì•ˆ ì •ì±… (ì˜¤ë””ì˜¤/ì´ë¯¸ì§€ ì—…ë¡œë“œìš©)
Supabase ëŒ€ì‹œë³´ë“œì˜ Storage ë©”ë‰´ì—ì„œ ë²„í‚·ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤. SQLë¡œë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ì•„ë˜ ì ˆì°¨ë¥¼ ë”°ë¥´ëŠ” ê²ƒì´ ë” í™•ì‹¤í•©ë‹ˆë‹¤.

Supabase ëŒ€ì‹œë³´ë“œ -> Storage -> New Bucket í´ë¦­.

ë²„í‚· ì´ë¦„: lms-assets (ë˜ëŠ” audio-files)

Public Bucket: ì²´í¬ âœ… (ê·¸ë˜ì•¼ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ URLë¡œ ì ‘ê·¼ ê°€ëŠ¥)

ìƒì„± í›„, í•´ë‹¹ ë²„í‚·ì˜ Configuration -> Policies íƒ­ì—ì„œ ì•„ë˜ SQLì„ ì‹¤í–‰í•˜ê±°ë‚˜ UIë¡œ ì„¤ì •í•˜ì„¸ìš”.

SQL

-- Storage ì •ì±… (SQL Editorì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
-- ê°€ì •: ë²„í‚· ì´ë¦„ì´ 'lms-assets' ì¼ ë•Œ

-- 1. ì¡°íšŒ (Download): ëˆ„êµ¬ë‚˜ ê°€ëŠ¥ (Public Bucketì´ë¯€ë¡œ)
-- (UI ì„¤ì • ì‹œ: Give users access to select/download)

-- 2. ì—…ë¡œë“œ (Insert): ë¡œê·¸ì¸í•œ ì‚¬ìš©ì(í•™ìƒ/êµì‚¬) ëˆ„êµ¬ë‚˜ ê°€ëŠ¥
create policy "Authenticated users can upload assets"
on storage.objects for insert
with check ( bucket_id = 'lms-assets' and auth.role() = 'authenticated' );

-- 3. ìˆ˜ì •/ì‚­ì œ: ë³¸ì¸ì´ ì˜¬ë¦° íŒŒì¼ë§Œ ê°€ëŠ¥
create policy "Users can update own assets"
on storage.objects for update
using ( bucket_id = 'lms-assets' and owner = auth.uid() );

create policy "Users can delete own assets"
on storage.objects for delete
using ( bucket_id = 'lms-assets' and owner = auth.uid() );